{% extends "base.html" %}

{% block title %}Security Audit - {{ filename }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <!-- File Information -->
        <div class="card shadow-lg border-0 mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-shield-check"></i> Security Audit Trail</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary">File Information</h6>
                        <ul class="list-unstyled">
                            <li><strong>File ID:</strong> {{ file_id }}</li>
                            <li><strong>Filename:</strong> {{ filename }}</li>
                            <li><strong>Owner:</strong> {{ owner }}</li>
                            <li><strong>Authorized Users:</strong> {{ authorized_users|join(', ') if authorized_users else 'Owner only' }}</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-primary">Security Status</h6>
                        <ul class="list-unstyled">
                            <li><strong>Data Confidentiality:</strong> 
                                <span class="badge bg-{{ 'success' if security_verification.data_confidentiality == 'maintained' else 'danger' }}">
                                    {{ security_verification.data_confidentiality|title }}
                                </span>
                            </li>
                            <li><strong>Access Control:</strong> 
                                <span class="badge bg-{{ 'success' if security_verification.access_control == 'enforced' else 'warning' }}">
                                    {{ security_verification.access_control|title }}
                                </span>
                            </li>
                            <li><strong>Cryptographic Verification:</strong> 
                                <span class="badge bg-{{ 'success' if security_verification.cryptographic_verification == 'verified' else 'danger' }}">
                                    {{ security_verification.cryptographic_verification|title }}
                                </span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Security Events Summary -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0"><i class="bi bi-graph-up"></i> Security Events Summary</h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h3 class="text-success">{{ security_verification.security_events.successful_accesses }}</h3>
                                <p class="mb-0">Successful Accesses</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h3 class="text-danger">{{ security_verification.security_events.unauthorized_attempts }}</h3>
                                <p class="mb-0">Unauthorized Attempts</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h3 class="text-warning">{{ security_verification.security_events.failed_decryptions }}</h3>
                                <p class="mb-0">Failed Decryptions</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h3 class="text-primary">{{ audit_trail|length }}</h3>
                                <p class="mb-0">Total Events</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Audit Trail -->
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-dark text-white">
                <h6 class="mb-0"><i class="bi bi-list-ul"></i> Complete Audit Trail</h6>
            </div>
            <div class="card-body">
                {% if audit_trail %}
                    <div class="timeline">
                        {% for event in audit_trail %}
                            <div class="timeline-item">
                                <div class="timeline-marker bg-{{ 'success' if event.event == 'authorized_access' else 'danger' if event.event == 'unauthorized_access_attempt' else 'warning' if event.event == 'decryption_failed' else 'primary' }}"></div>
                                <div class="timeline-content">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h6 class="mb-1">
                                                {% if event.event == 'file_uploaded' %}
                                                    <i class="bi bi-cloud-upload text-primary"></i> File Uploaded
                                                {% elif event.event == 'authorized_access' %}
                                                    <i class="bi bi-check-circle text-success"></i> Authorized Access
                                                {% elif event.event == 'unauthorized_access_attempt' %}
                                                    <i class="bi bi-x-circle text-danger"></i> Unauthorized Access Attempt
                                                {% elif event.event == 'decryption_failed' %}
                                                    <i class="bi bi-exclamation-triangle text-warning"></i> Decryption Failed
                                                {% endif %}
                                            </h6>
                                            <p class="mb-1">{{ event.description }}</p>
                                            {% if event.user %}
                                                <small class="text-muted">User: {{ event.user }}</small>
                                            {% endif %}
                                            {% if event.reason %}
                                                <small class="text-muted">Reason: {{ event.reason }}</small>
                                            {% endif %}
                                            {% if event.error %}
                                                <small class="text-muted">Error: {{ event.error }}</small>
                                            {% endif %}
                                        </div>
                                        <small class="text-muted">
                                            {{ event.timestamp|strftime('%Y-%m-%d %H:%M:%S') if event.timestamp else 'Unknown' }}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center text-muted">
                        <i class="bi bi-info-circle fs-1"></i>
                        <p class="mt-3">No security events recorded for this file.</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Actions -->
        <div class="text-center mt-4">
            <a href="{{ url_for('files') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to Files
            </a>
            <a href="{{ url_for('decrypt', file_id=file_id) }}" class="btn btn-primary">
                <i class="bi bi-unlock"></i> Decrypt File
            </a>
        </div>
    </div>
</div>

<style>
.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 15px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #dee2e6;
}

.timeline-item {
    position: relative;
    margin-bottom: 20px;
}

.timeline-marker {
    position: absolute;
    left: -22px;
    top: 5px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid #fff;
    box-shadow: 0 0 0 2px #dee2e6;
}

.timeline-content {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    border-left: 3px solid #007bff;
}
</style>
{% endblock %}
